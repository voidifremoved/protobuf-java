package com.rubberjam.protobuf.compiler.cpp;

import com.google.protobuf.Descriptors.FileDescriptor;
import java.io.PrintWriter;

public class CppFileGenerator {
    private final FileDescriptor file;

    public CppFileGenerator(FileDescriptor file) {
        this.file = file;
    }

    public void generateHeader(PrintWriter writer) {
        String filename = file.getName();
        String guard = "GOOGLE_PROTOBUF_INCLUDED_" + filename.replace('.', '_').replace('/', '_').toUpperCase();

        writer.println("// Generated by the protocol buffer compiler.  DO NOT EDIT!");
        writer.println("// source: " + filename);
        writer.println();
        writer.println("#ifndef " + guard);
        writer.println("#define " + guard);
        writer.println();
        writer.println("#include <string>");
        writer.println("#include <google/protobuf/message.h>");
        writer.println();

        String namespace = file.getPackage();
        if (!namespace.isEmpty()) {
            String[] parts = namespace.split("\\.");
            for (String part : parts) {
                writer.println("namespace " + part + " {");
            }
            writer.println();
        }

        for (com.google.protobuf.Descriptors.Descriptor messageType : file.getMessageTypes()) {
            writer.println("class " + messageType.getName() + ";");
        }
        writer.println();

        for (com.google.protobuf.Descriptors.Descriptor messageType : file.getMessageTypes()) {
            writer.println("class " + messageType.getName() + " : public ::google::protobuf::Message {");
            writer.println(" public:");
            writer.println("  " + messageType.getName() + "();");
            writer.println("  virtual ~" + messageType.getName() + "();");
            writer.println();
            writer.println("  // Implements Message");
            writer.println("  size_t ByteSizeLong() const final;");
            writer.println("  const char* _InternalParse(const char* ptr, ::google::protobuf::internal::ParseContext* ctx) final;");
            writer.println("  ::uint8_t* _InternalSerialize(::uint8_t* target, ::google::protobuf::io::EpsCopyOutputStream* stream) const final;");
            writer.println("};");
            writer.println();
        }

        if (!namespace.isEmpty()) {
            String[] parts = namespace.split("\\.");
            for (int i = 0; i < parts.length; i++) {
                writer.println("}  // namespace " + parts[parts.length - 1 - i]);
            }
        }

        writer.println();
        writer.println("#endif  // " + guard);
    }

    public void generateSource(PrintWriter writer, String headerFilename) {
        writer.println("// Generated by the protocol buffer compiler.  DO NOT EDIT!");
        writer.println("// source: " + file.getName());
        writer.println();
        writer.println("#include \"" + headerFilename + "\"");
        writer.println("#include <google/protobuf/io/coded_stream.h>");
        writer.println("#include <google/protobuf/extension_set.h>");
        writer.println("#include <google/protobuf/wire_format_lite.h>");
        writer.println("#include <google/protobuf/descriptor.h>");
        writer.println("#include <google/protobuf/generated_message_reflection.h>");
        writer.println("#include <google/protobuf/reflection_ops.h>");
        writer.println("#include <google/protobuf/wire_format.h>");
        writer.println();

        String namespace = file.getPackage();
        if (!namespace.isEmpty()) {
            String[] parts = namespace.split("\\.");
            for (String part : parts) {
                writer.println("namespace " + part + " {");
            }
            writer.println();
        }

        for (com.google.protobuf.Descriptors.Descriptor messageType : file.getMessageTypes()) {
            String className = messageType.getName();
            writer.println(className + "::" + className + "() {}");
            writer.println(className + "::~" + className + "() {}");
            writer.println("size_t " + className + "::ByteSizeLong() const { return 0; }");
            writer.println("const char* " + className + "::_InternalParse(const char* ptr, ::google::protobuf::internal::ParseContext* ctx) { return ptr; }");
            writer.println("::uint8_t* " + className + "::_InternalSerialize(::uint8_t* target, ::google::protobuf::io::EpsCopyOutputStream* stream) const { return target; }");
            writer.println();
        }

        if (!namespace.isEmpty()) {
            String[] parts = namespace.split("\\.");
            for (int i = 0; i < parts.length; i++) {
                writer.println("}  // namespace " + parts[parts.length - 1 - i]);
            }
        }
    }
}
